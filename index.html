<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://blockly.co.in/img/favicon.ico" rel="icon" type="image/x-icon">
    <title>SchoolBus2.0 RFID Advanced Dashboard</title>
    <meta name="robots" content="noindex">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285F4 0%, #4285F4 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-filter label {
            font-weight: 600;
            color: #495057;
        }

        .date-filter input, .bus-filter select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); }

        .status-indicator {
            display: flex;
            align-items: center;
            font-size: 16px;
            color: rgba(0, 0, 0, 0.6);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease;
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.present { border-left-color: #28a745; }
        .stat-card.absent { border-left-color: #dc3545; }
        .stat-card.boarded { border-left-color: #007bff; }
        .stat-card.deboarded { border-left-color: #6c757d; }
        .stat-card.duplicate { border-left-color: #ffc107; }
        .stat-card.total { border-left-color: #6f42c1; }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 1.1em;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .student-card.present { border-color: #28a745; }
        .student-card.absent { border-color: #dc3545; }

        .student-header {
            padding: 20px;
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            color: white;
        }

        .student-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-details {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .student-body {
            padding: 20px;
        }

        .attendance-logs {
            margin-top: 15px;
        }

        .log-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: 500;
        }

        .log-entry.boarded {
            background: #E8F0FE;
            color: #343434;
        }

        .log-entry.deboarded {
            background: #F0F0F0;
            color: #343434;
        }

        .log-entry.duplicate {
            background: #FFF3CD;
            color: #856404;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-present { background: #d4edda; color: #155724; }
        .status-absent { background: #f8d7da; color: #721c24; }
        .status-boarded { background: #d1ecf1; color: #0c5460; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table th {
            background: #495057;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .bus-selector {
            margin-bottom: 20px;
        }

        .analytics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .export-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .date-controls {
                justify-content: center;
            }

            .student-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .analytics-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <img src="Bus.png" alt="Logo" class="logo" style="
                    width: clamp(40px, 6vw, 60px);
                    height: clamp(40px, 6vw, 60px);
                    vertical-align: middle;
                    margin-right: 15px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                ">  
                SchoolBus2.0 RFID Advanced Dashboard
            </h1>
            <p>Ashoka Universal School - Comprehensive Attendance Management</p>
        </div>

        <div class="controls">
            <div class="date-controls">
                <div class="date-filter">
                    <label for="fromDate">From:</label>
                    <input type="date" id="fromDate" value="">
                </div>
                <div class="date-filter">
                    <label for="toDate">To:</label>
                    <input type="date" id="toDate" value="">
                </div>
                <div class="date-filter">
                    <label for="busFilter">Bus:</label>
                    <select id="busFilter" class="bus-filter">
                        <option value="">All Buses</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="refreshAllData()">üîÑ Refresh</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
                <!-- <button class="btn btn-danger" onclick="exportToPDF()">üìÑ Export PDF</button> -->
            </div>
            
            <div class="status-indicator">
                <span id="lastUpdated">Last Updated: -</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
            <button class="tab" onclick="showTab('attendance')">üë• Attendance</button>
            <button class="tab" onclick="window.location.href='reports.html'">üìã Reports</button>
            <button class="tab" onclick="showTab('data')">üóÇÔ∏è Raw Data</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card present">
                        <div class="stat-number" id="presentStudents">0</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card boarded">
                        <div class="stat-number" id="boardedCount">0</div>
                        <div class="stat-label">Currently Boarded</div>
                    </div>
                    <div class="stat-card deboarded">
                        <div class="stat-number" id="deboardedCount">0</div>
                        <div class="stat-label">Deboarded Today</div>
                    </div>
                    <div class="stat-card duplicate">
                        <div class="stat-number" id="duplicateCount">0</div>
                        <div class="stat-label">Duplicate Taps</div>
                    </div>
                    <div class="stat-card total">
                        <div class="stat-number" id="totalBuses">0</div>
                        <div class="stat-label">Active Buses</div>
                    </div>
                </div>

                <div class="analytics-row">
                    <div class="chart-container">
                        <div class="chart-title">Attendance Overview</div>
                        <canvas id="attendanceChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Hourly Activity</div>
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <div id="busWiseStats" class="stats-grid">
                    <!-- Bus-wise statistics will be populated here -->
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <div class="export-section">
                    <div class="export-title">üìä Advanced Analytics & Reports</div>
                    <div class="export-buttons">
                        <button class="btn" onclick="generateMonthlyReport()">üìÖ Monthly Report</button>
                        <button class="btn btn-info" onclick="generateBusWiseReport()">üöå Bus-wise Analysis</button>
                        <button class="btn btn-success" onclick="generateStudentReport()">üë§ Student Analysis</button>
                        <button class="btn btn-danger" onclick="generateDuplicateReport()">‚ö†Ô∏è Duplicate Analysis</button>
                    </div>
                </div>

                <div class="analytics-row">
                    <div class="chart-container">
                        <div class="chart-title">Bus Utilization</div>
                        <canvas id="busUtilizationChart"></canvas>
                    </div>
                        <div class="chart-container">
                            <div class="chart-title">Weekly Trends</div>
                            <canvas id="weeklyTrendChart"></canvas>
                        </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Student Activity Timeline</div>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendanceTab" class="tab-content">
                <div class="bus-selector">
                    <label for="attendanceBusFilter">Filter by Bus: </label>
                    <select id="attendanceBusFilter" onchange="filterAttendanceByBus()">
                        <option value="">All Buses</option>
                    </select>
                </div>

                <div id="studentCards" class="student-grid">
                    <div class="loading">Loading attendance data...</div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content">
                <div class="export-section">
                    <div class="export-title">üìã Generate Custom Reports</div>
                    <p>Select date range and bus to generate detailed reports in Excel or PDF format.</p>
                    
                    <div style="margin: 20px 0;">
                        <h4>Available Report Types:</h4>
                        <div class="export-buttons" style="margin-top: 10px;">
                            <button class="btn" onclick="generateDetailedReport('student')">üë§ Student Attendance Report</button>
                            <button class="btn btn-info" onclick="generateDetailedReport('bus')">üöå Bus Activity Report</button>
                            <button class="btn btn-success" onclick="generateDetailedReport('daily')">üìÖ Daily Summary Report</button>
                            <button class="btn btn-danger" onclick="generateDetailedReport('duplicate')">‚ö†Ô∏è Duplicate Taps Report</button>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Report Preview</div>
                    <div id="reportPreview">
                        <p>Select a report type above to preview the data that will be included in your export.</p>
                    </div>
                </div>
            </div>

            <!-- Data Tab -->
            <div id="dataTab" class="tab-content">
                <div class="export-section">
                    <div class="export-title">üóÇÔ∏è Raw Data Table</div>
                    <div class="export-buttons">
                        <button class="btn" onclick="loadRawData('all')">All Records</button>
                        <button class="btn btn-info" onclick="loadRawData('today')">Today's Records</button>
                        <button class="btn btn-success" onclick="loadRawData('duplicate')">Duplicate Records</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="rawDataTable">
                        <thead>
                            <tr>
                                <th>RFID</th>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Bus</th>
                                <th>Status</th>
                                <th>Time</th>
                                <!-- <th>Duplicate</th> -->
                            </tr>
                        </thead>
                        <tbody id="rawDataTableBody">
                            <tr><td colspan="7" class="loading">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allStudentsData = [];
        let attendanceCountsData = null;
        let busAttendanceData = {};
        let currentDateRange = {
            from: new Date().toISOString().split('T')[0],
            to: new Date().toISOString().split('T')[0]
        };
        let charts = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadAllData();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadAllData();
                updateLastUpdatedTime();
            }, 30000);
            
            updateLastUpdatedTime();
        });

        function initializeDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
            currentDateRange = { from: today, to: today };
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
        }

        // Convert UTC time to IST (UTC+5:30)
        function convertToIST(utcTimeString) {
            if (!utcTimeString || !utcTimeString.includes('+00:00')) return utcTimeString;
            
            const utcDate = new Date(utcTimeString);
            const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
            const istDate = new Date(utcDate.getTime() + istOffset);
            
            return istDate.toISOString().replace('Z', '+05:30');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(convertToIST(dateTimeString));
            return date.toLocaleString('en-IN');
        }

        function formatTime(dateTimeString) {
            const date = new Date(convertToIST(dateTimeString));
            return date.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // API calls
        async function fetchStudentsWithAttendance(fromDate, toDate) {
            try {
                const response = await fetch(`https://schoolbusapi.com/parent/rfid/students-with-attendance/?from_date=${fromDate}&to_date=${toDate}`);
                if (!response.ok) throw new Error('Failed to fetch students data');
                return await response.json();
            } catch (error) {
                console.error('Error fetching students:', error);
                return [];
            }
        }

        async function fetchAttendanceCounts(fromDate, toDate) {
            try {
                const response = await fetch(`https://schoolbusapi.com/parent/rfid/attendance-counts/?from_date=${fromDate}&to_date=${toDate}`);
                if (!response.ok) throw new Error('Failed to fetch attendance counts');
                return await response.json();
            } catch (error) {
                console.error('Error fetching attendance counts:', error);
                return { boarded_count: 0, deboarded_count: 0, attendances: [] };
            }
        }

        async function fetchBusAttendance(mid) {
            try {
                const response = await fetch(`https://schoolbusapi.com/parent/rfid/bus-attendance/?mid=${mid}`);
                if (!response.ok) throw new Error('Failed to fetch bus attendance');
                return await response.json();
            } catch (error) {
                console.error('Error fetching bus attendance:', error);
                return null;
            }
        }

        // Main data loading function
        async function loadAllData() {
            const fromDate = document.getElementById('fromDate').value || currentDateRange.from;
            const toDate = document.getElementById('toDate').value || currentDateRange.to;
            
            currentDateRange = { from: fromDate, to: toDate };

            try {
                // Load students and attendance data
                allStudentsData = await fetchStudentsWithAttendance(fromDate, toDate);
                attendanceCountsData = await fetchAttendanceCounts(fromDate, toDate);

                // Get unique bus IDs and load bus data
                const busIds = [...new Set(allStudentsData.flatMap(student => 
                    student.attendance_by_mid.map(att => att.mid).filter(mid => mid)
                ))];

                busAttendanceData = {};
                for (const mid of busIds) {
                    if (mid) {
                        busAttendanceData[mid] = await fetchBusAttendance(mid);
                    }
                }

                // Update UI
                updateDashboard();
                updateAttendanceView();
                updateBusFilters();
                updateCharts();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please check your connection and try again.');
            }
        }

        function updateDashboard() {
            // Calculate statistics
            const totalStudents = allStudentsData.length;
            const presentStudents = allStudentsData.filter(student => 
                student.attendance_by_mid.some(att => att.attendances.length > 0)
            ).length;

            let currentlyBoarded = 0;
            let totalDuplicates = 0;

            // Process attendance data
            allStudentsData.forEach(student => {
                student.attendance_by_mid.forEach(midGroup => {
                    const attendances = midGroup.attendances || [];
                    // Count duplicates
                    totalDuplicates += attendances.filter(att => att.duplicate).length;
                    
                    // Check current boarding status
                    if (attendances.length > 0) {
                        const lastAttendance = attendances[attendances.length - 1];
                        if (lastAttendance.status === 'boarded') {
                            currentlyBoarded++;
                        }
                    }
                });
            });

            // Update dashboard stats
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('presentStudents').textContent = presentStudents;
            document.getElementById('boardedCount').textContent = currentlyBoarded;
            document.getElementById('deboardedCount').textContent = attendanceCountsData.deboarded_count || 0;
            document.getElementById('duplicateCount').textContent = totalDuplicates;
            document.getElementById('totalBuses').textContent = Object.keys(busAttendanceData).length;

            // Update bus-wise statistics
            updateBusWiseStats();
        }

        function updateBusWiseStats() {
            const container = document.getElementById('busWiseStats');
            let html = '';

            Object.entries(busAttendanceData).forEach(([mid, busData]) => {
                if (!busData) return;

                const studentsOnBus = busData.students.length;
                const activeStudents = busData.students.filter(student => 
                    student.attendances && student.attendances.length > 0
                ).length;

                html += `
                    <div class="stat-card boarded">
                        <div class="stat-number">${activeStudents}/${studentsOnBus}</div>
                        <div class="stat-label">Bus ${busData.bus_number}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateAttendanceView() {
            const container = document.getElementById('studentCards');
            const selectedBus = document.getElementById('attendanceBusFilter').value;
            
            let filteredStudents = allStudentsData;
            if (selectedBus) {
                filteredStudents = allStudentsData.filter(student =>
                    student.attendance_by_mid.some(att => att.mid === selectedBus)
                );
            }

            if (filteredStudents.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: #6c757d;">
                        üìã No attendance records found for the selected criteria
                        <br><br>
                        <small>Students may not have used the bus today or data is still being updated.</small>
                    </div>
                `;
                return;
            }

            let html = '';
            
            filteredStudents.forEach(student => {
                const hasAttendance = student.attendance_by_mid.some(att => att.attendances.length > 0);
                const isPresent = hasAttendance;
                
                // Get current boarding status
                let currentlyBoarded = false;
                let allAttendances = [];
                
                student.attendance_by_mid.forEach(midGroup => {
                    allAttendances.push(...(midGroup.attendances || []));
                });
                
                // Sort by time to get latest status
                allAttendances.sort((a, b) => new Date(a.time) - new Date(b.time));
                if (allAttendances.length > 0) {
                    const lastAttendance = allAttendances[allAttendances.length - 1];
                    currentlyBoarded = lastAttendance.status === 'boarded';
                }

                html += `
                    <div class="student-card ${isPresent ? 'present' : 'absent'}">
                        <div class="student-header">
                            <div class="student-name">${student.student_name}</div>
                            <div class="student-details">
                                RFID: ${student.rfid} | Class: ${student.class_name}-${student.section} | ${student.gender}
                            </div>
                        </div>
                        <div class="student-body">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span><strong style="color: #4285F4;">Status:</strong></span>
                                <span class="status-badge ${isPresent ? 'status-present' : 'status-absent'}">
                                    ${isPresent ? '‚úÖ Present' : '‚ùå Absent'}
                                </span>
                            </div>
                            
                            ${currentlyBoarded ? 
                                '<div style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold;">üöå Currently on Bus</div>' 
                                : ''}
                            
                            <div class="attendance-logs">
                                <h4 style="margin-bottom: 10px; color: #4285F4;">Today's Activity Log</h4>
                                ${allAttendances.length > 0 ? allAttendances.map(log => `
                                    <div class="log-entry ${log.status}">
                                        <span>
                                            ${log.status === 'boarded' ? 
                                                '<img src="board-svg.svg" alt="Boarded" style="width:16px; height:16px; vertical-align:middle;"> Boarded' : 
                                                log.status === 'deboarded' ?
                                                '<img src="deboard-svg.svg" alt="Deboarded" style="width:16px; height:16px; vertical-align:middle;"> Deboarded' :
                                                '‚ö†Ô∏è Duplicate Tap'
                                            }
                                            ${log.duplicate ? ' (Duplicate)' : ''}
                                        </span>
                                        <span>${formatTime(log.time)}</span>
                                    </div>
                                `).join('') : '<p style="color: #6c757d; font-style: italic;">No activity recorded today</p>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateBusFilters() {
            const busFilter = document.getElementById('busFilter');
            const attendanceBusFilter = document.getElementById('attendanceBusFilter');
            
            // Get all unique buses
            const buses = Object.values(busAttendanceData).filter(bus => bus);
            
            const busOptions = buses.map(bus => 
                `<option value="${bus.mid}">${bus.bus_number}</option>`
            ).join('');
            
            busFilter.innerHTML = '<option value="">All Buses</option>' + busOptions;
            attendanceBusFilter.innerHTML = '<option value="">All Buses</option>' + busOptions;
        }

        function updateCharts() {
            // Attendance Overview Chart
            updateAttendanceChart();
            
            // Activity Chart (hourly)
            updateActivityChart();
            
            // Bus Utilization Chart
            updateBusUtilizationChart();
            
            // Weekly Trend Chart
            updateWeeklyTrendChart();
            
            // Timeline Chart
            updateTimelineChart();
        }

        function updateAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            if (charts.attendanceChart) {
                charts.attendanceChart.destroy();
            }
            
            const totalStudents = allStudentsData.length;
            const presentStudents = allStudentsData.filter(student => 
                student.attendance_by_mid.some(att => att.attendances.length > 0)
            ).length;
            
            charts.attendanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [presentStudents, totalStudents - presentStudents],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (charts.activityChart) {
                charts.activityChart.destroy();
            }
            
            // Process hourly activity
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = { boarded: 0, deboarded: 0, duplicate: 0 };
            }
            
            if (attendanceCountsData && attendanceCountsData.attendances) {
                attendanceCountsData.attendances.forEach(attendance => {
                    const hour = new Date(convertToIST(attendance.time)).getHours();
                    if (attendance.duplicate) {
                        hourlyData[hour].duplicate++;
                    } else {
                        hourlyData[hour][attendance.status]++;
                    }
                });
            }
            
            const hours = Object.keys(hourlyData);
            const boardedData = hours.map(h => hourlyData[h].boarded);
            const deboardedData = hours.map(h => hourlyData[h].deboarded);
            const duplicateData = hours.map(h => hourlyData[h].duplicate);
            
            charts.activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'Boarded',
                            data: boardedData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Deboarded',
                            data: deboardedData,
                            borderColor: '#6c757d',
                            backgroundColor: 'rgba(108, 117, 125, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Duplicates',
                            data: duplicateData,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateBusUtilizationChart() {
            const ctx = document.getElementById('busUtilizationChart').getContext('2d');
            
            if (charts.busUtilizationChart) {
                charts.busUtilizationChart.destroy();
            }
            
            const busLabels = [];
            const utilizationData = [];
            
            Object.values(busAttendanceData).forEach(bus => {
                if (bus) {
                    busLabels.push(bus.bus_number);
                    const activeStudents = bus.students.filter(student => 
                        student.attendances && student.attendances.length > 0
                    ).length;
                    utilizationData.push(activeStudents);
                }
            });
            
            charts.busUtilizationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: busLabels,
                    datasets: [{
                        label: 'Active Students',
                        data: utilizationData,
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateWeeklyTrendChart() {
            const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
            
            if (charts.weeklyTrendChart) {
                charts.weeklyTrendChart.destroy();
            }
            
            // Mock weekly data (you can enhance this with actual historical data)
            const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const trendData = weekDays.map(() => Math.floor(Math.random() * 100) + 50);
            
            charts.weeklyTrendChart = new Chart(ctx, {
                type: 'line',
                // data: {
                //     labels: weekDays,
                //     datasets: [{
                //         label: 'Daily Attendance',
                //         data: trendData,
                //         borderColor: '#28a745',
                //         backgroundColor: 'rgba(40, 167, 69, 0.1)',
                //         tension: 0.4,
                //         fill: true
                //     }]
                // },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timelineChart) {
                charts.timelineChart.destroy();
            }
            
            // Process timeline data
            const timelineData = [];
            if (attendanceCountsData && attendanceCountsData.attendances) {
                const sortedAttendances = attendanceCountsData.attendances
                    .sort((a, b) => new Date(a.time) - new Date(b.time));
                
                let cumulativeCount = 0;
                sortedAttendances.forEach(attendance => {
                    if (attendance.status === 'boarded') cumulativeCount++;
                    else if (attendance.status === 'deboarded') cumulativeCount--;
                    
                    timelineData.push({
                        x: formatTime(attendance.time),
                        y: cumulativeCount
                    });
                });
            }
            
            charts.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Students on Bus',
                        data: timelineData,
                        borderColor: '#6f42c1',
                        backgroundColor: 'rgba(111, 66, 193, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Tab management
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load specific data for some tabs
            if (tabName === 'data') {
                loadRawData('today');
            }
        }

        // Export functions
        function exportToExcel() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const selectedBus = document.getElementById('busFilter').value;
            
            const workbook = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['SchoolBus2.0 RFID Attendance Report'],
                ['Generated on:', new Date().toLocaleString()],
                ['Date Range:', `${fromDate} to ${toDate}`],
                ['Bus Filter:', selectedBus || 'All Buses'],
                [],
                ['Summary Statistics'],
                ['Total Students:', allStudentsData.length],
                ['Present Students:', allStudentsData.filter(s => s.attendance_by_mid.some(a => a.attendances.length > 0)).length],
                ['Total Buses:', Object.keys(busAttendanceData).length],
                [],
                ['Attendance Details']
            ];
            
            // Add student details
            allStudentsData.forEach(student => {
                if (!selectedBus || student.attendance_by_mid.some(att => att.mid === selectedBus)) {
                    summaryData.push([
                        student.rfid,
                        student.student_name,
                        `${student.class_name}-${student.section}`,
                        student.gender,
                        student.attendance_by_mid.some(att => att.attendances.length > 0) ? 'Present' : 'Absent'
                    ]);
                }
            });
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
            
            // Raw data sheet
            const rawData = [['RFID', 'Student Name', 'Class', 'Bus', 'Status', 'Time', 'Duplicate']];
            
            if (attendanceCountsData && attendanceCountsData.attendances) {
                attendanceCountsData.attendances.forEach(record => {
                    if (!selectedBus || record.mid === selectedBus) {
                        rawData.push([
                            record.rfid,
                            record.student_name,
                            '', // You can enhance this with class info
                            record.mid || 'Unknown',
                            record.status,
                            formatDateTime(record.time),
                            // record.duplicate ? 'Yes' : 'No'
                        ]);
                    }
                });
            }
            
            const rawSheet = XLSX.utils.aoa_to_sheet(rawData);
            XLSX.utils.book_append_sheet(workbook, rawSheet, 'Raw Data');
            
            // Save file
            const fileName = `RFID_Report_${fromDate}_to_${toDate}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const selectedBus = document.getElementById('busFilter').value;
            
            // Title
            doc.setFontSize(20);
            doc.text('SchoolBus2.0 RFID Attendance Report', 20, 30);
            
            // Header info
            doc.setFontSize(12);
            doc.text(`Report Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`Date Range: ${fromDate} to ${toDate}`, 20, 55);
            oc.text(`Bus: ${"MH 15 EF 0162" || 'All Buses'}`, 20, 65);
            // doc.text(`Bus Filter: ${selectedBus || 'All Buses'}`, 20, 65);
            
            
            // Summary statistics
            doc.setFontSize(16);
            doc.text('Summary Statistics', 20, 85);
            
            doc.setFontSize(12);
            const stats = [
                ['Total Students', allStudentsData.length.toString()],
                ['Present Students', allStudentsData.filter(s => s.attendance_by_mid.some(a => a.attendances.length > 0)).length.toString()]
                // ['Total Buses', Object.keys(busAttendanceData).length.toString()]
            ];
            
            doc.autoTable({
                startY: 95,
                head: [['Metric', 'Value']],
                body: stats,
                theme: 'grid'
            });
            
            // Student attendance table
            const studentData = [];
            allStudentsData.forEach(student => {
                if (!selectedBus || student.attendance_by_mid.some(att => att.mid === selectedBus)) {
                    studentData.push([
                        student.rfid,
                        student.student_name,
                        `${student.class_name}-${student.section}`,
                        student.gender,
                        student.attendance_by_mid.some(att => att.attendances.length > 0) ? 'Present' : 'Absent'
                    ]);
                }
            });
            
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 20,
                head: [['RFID', 'Student Name', 'Class', 'Gender', 'Status']],
                body: studentData,
                theme: 'grid',
                styles: { fontSize: 8 }
            });
            
            // Save PDF
            const fileName = `RFID_Report_${fromDate}_to_${toDate}.pdf`;
            doc.save(fileName);
        }

        // Advanced report generation
        function generateDetailedReport(type) {
            const preview = document.getElementById('reportPreview');
            
            switch(type) {
                case 'student':
                    generateStudentReport();
                    break;
                case 'bus':
                    generateBusReport();
                    break;
                case 'daily':
                    generateDailyReport();
                    break;
                case 'duplicate':
                    generateDuplicateReport();
                    break;
            }
        }

        function generateStudentReport() {
            const preview = document.getElementById('reportPreview');
            let html = '<h4>Student Attendance Report Preview</h4>';
            html += '<table class="data-table"><thead><tr><th>RFID</th><th>Name</th><th>Class</th><th>Total Trips</th><th>Last Activity</th></tr></thead><tbody>';
            
            allStudentsData.forEach(student => {
                const totalTrips = student.attendance_by_mid.reduce((sum, att) => sum + att.attendances.length, 0);
                const lastActivity = student.attendance_by_mid
                    .flatMap(att => att.attendances)
                    .sort((a, b) => new Date(b.time) - new Date(a.time))[0];
                
                html += `<tr>
                    <td>${student.rfid}</td>
                    <td>${student.student_name}</td>
                    <td>${student.class_name}-${student.section}</td>
                    <td>${totalTrips}</td>
                    <td>${lastActivity ? formatDateTime(lastActivity.time) : 'No activity'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        function generateBusReport() {
            const preview = document.getElementById('reportPreview');
            let html = '<h4>Bus Activity Report Preview</h4>';
            html += '<table class="data-table"><thead><tr><th>Bus Number</th><th>Total Students</th><th>Active Today</th><th>Utilization %</th></tr></thead><tbody>';
            
            Object.values(busAttendanceData).forEach(bus => {
                if (bus) {
                    const totalStudents = bus.students.length;
                    const activeStudents = bus.students.filter(s => s.attendances && s.attendances.length > 0).length;
                    const utilization = totalStudents > 0 ? ((activeStudents / totalStudents) * 100).toFixed(1) : 0;
                    
                    html += `<tr>
                        <td>${bus.bus_number}</td>
                        <td>${totalStudents}</td>
                        <td>${activeStudents}</td>
                        <td>${utilization}%</td>
                    </tr>`;
                }
            });
            
            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        function generateDailyReport() {
            const preview = document.getElementById('reportPreview');
            let html = '<h4>Daily Summary Report Preview</h4>';
            
            const totalStudents = allStudentsData.length;
            const presentStudents = allStudentsData.filter(s => s.attendance_by_mid.some(a => a.attendances.length > 0)).length;
            const totalBuses = Object.keys(busAttendanceData).length;
            
            html += `
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="stat-number">${totalStudents}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card present">
                        <div class="stat-number">${presentStudents}</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card total">
                        <div class="stat-number">${totalBuses}</div>
                        <div class="stat-label">Active Buses</div>
                    </div>
                </div>
            `;
            
            preview.innerHTML = html;
        }

        function generateDuplicateReport() {
            const preview = document.getElementById('reportPreview');
            let html = '<h4>Duplicate Taps Report Preview</h4>';
            html += '<table class="data-table"><thead><tr><th>RFID</th><th>Student Name</th><th>Time</th><th>Bus</th><th>Action</th></tr></thead><tbody>';
            
            if (attendanceCountsData && attendanceCountsData.attendances) {
                const duplicates = attendanceCountsData.attendances.filter(att => att.duplicate);
                
                duplicates.forEach(dup => {
                    html += `<tr>
                        <td>${dup.rfid}</td>
                        <td>${dup.student_name}</td>
                        <td>${formatDateTime(dup.time)}</td>
                        <td>${dup.mid || 'Unknown'}</td>
                        <td>‚ö†Ô∏è Duplicate ${dup.status}</td>
                    </tr>`;
                });
            }
            
            html += '</tbody></table>';
            preview.innerHTML = html;
        }

        // Raw data functions
        function loadRawData(filter) {
            const tbody = document.getElementById('rawDataTableBody');
            let html = '';
            
            if (!attendanceCountsData || !attendanceCountsData.attendances) {
                html = '<tr><td colspan="7">No data available</td></tr>';
            } else {
                let filteredData = attendanceCountsData.attendances;
                
                if (filter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    filteredData = filteredData.filter(record => 
                        record.time.startsWith(today)
                    );
                } else if (filter === 'duplicate') {
                    filteredData = filteredData.filter(record => record.duplicate);
                }
                
                filteredData.forEach(record => {
                    html += `<tr>
                        <td>${record.rfid}</td>
                        <td>${record.student_name}</td>
                        <td>-</td>
                        <td>${'MH 15 EF 0162'}</td>
                        <td>
                            <span class="status-badge ${record.status === 'boarded' ? 'status-boarded' : record.status === 'deboarded' ? 'status-absent' : 'status-present'}">
                                ${record.status} ${record.duplicate ? '(Duplicate)' : ''}
                            </span>
                        </td>
                        <td>${formatDateTime(record.time)}</td>
                        
                    </tr>`;
                });
            }
            
            tbody.innerHTML = html;
        }

        // Filter functions
        function filterAttendanceByBus() {
            updateAttendanceView();
        }

        function refreshAllData() {
            loadAllData();
        }

        // Date change handlers
        document.getElementById('fromDate').addEventListener('change', loadAllData);
        document.getElementById('toDate').addEventListener('change', loadAllData);
        document.getElementById('busFilter').addEventListener('change', loadAllData);

        // Additional utility functions
        function showError(message) {
            const container = document.getElementById('studentCards');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function generateMonthlyReport() {
            alert('Monthly report generation would require additional date range selection. This feature can be enhanced further.');
        }

        function generateBusWiseReport() {
            exportToExcel(); // Use existing export function for now
        }

        function generateStudentReport() {
            generateDetailedReport('student');
        }
    </script>
</body>
</html>
